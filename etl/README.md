
# ETL

Сервис, переносящий дату из Postgres в ElasticSearch.


## Environment Variables

Все переменные среды уже установлены в `.env.template`. Только переименовать.

`INTERVAL` время между запусками всех трёх ETL в секундах.
## Запуск

`docker compose up` - запускает все сервисы.

ETL процесс не стартует миграцию данных пока мы не создадим индексы.
Это сделано для того, чтобы предотвратить автоматическое создание индексов.
Чтобы создать индексы:

 - `cd ./etl/etl_libs/index_jsons_dir`
 - `chmod +x create-index.sh`
 - `./create-index.sh`


## Об изменениях в коде

#### Код построен вокруг базовых классов
- `BaseETLProcess` реализует базовый функционал для трех классов ETL-процессов. 
- `BaseExtractor` реализует базовый функционал для Экстракторов.
- `BaseTransformer` служит только для тайпинга.
- `Loader` только распаковывает полученные модели в запрос к ETL, поэтому не имеет разных имплементаций.

#### Каждый из конкретных ETL-процессов получил тольк список полей
- `TABLES` - таблицы, которые нужно проверять на наличие изменений. Genre и Person никак не влияют друг на друга, поэтому не входят в эти списки друг у друга.
- `INDICES_MAPPING` - маппинг названий таблиц в Postgres и индексов в Elastic.
- `MAIN_TABLE` - название основной таблицы, с которой ведёт работу процесс. Например, для прошлого ETL это был бы `film_work`.
- `EXTRACTOR_CLASS`, `TRANSFORMER_CLASS` - классы экстрактора и трансформера.
- `LOADER_CLASS` - класс Loader'а. В нашем случае он всегда один.
Весь остальной их код _(запуск и работа со State)_ вынесен в базовый класс. Запуск осуществляется методом `run`.

#### Каждый конкретный Extractor перегружает всего один метод базового
Базовый экстрактор реализует весь функционал по поиску обновлённых записей, выяснению, на какие записи из его `MAIN_TABLE` и возврату ID этих записей.

Конкретные экстракторы берут только список этих ID и используют в своём `fetch_by_ids`. Метод принимает возвращает список строк из базы.


#### Затем ETL-процесс передаёт полученные словари конкретному Трансформеру.
Он возвращает список моделек Pydantic.

#### И одинаковый для всех Loader загружает эти модельки.